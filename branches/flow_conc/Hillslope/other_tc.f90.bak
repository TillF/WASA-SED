  

  IF (templat > 0.) THEN
    watbal=watbal+templat/(tcarea2*1.e3)
    IF (nbr_svc(tcid_instance2) == 0) THEN		!Till: if whole TC consists of rock...
      q_surf_out=q_surf_out+templat
    ELSE IF (.NOT. dolatsc) THEN
      q_surf_out=q_surf_out+templat*rocky(tcid_instance2)
    ELSE
      q_surf_out=q_surf_out+templat*rocky(tcid_instance2)*rocky(tcid_instance2)
    END IF
    
    
    DO i=1,nbr_svc(tcid_instance2)
      
      soilid=id_soil_intern(i,tcid_instance2)
      remainlat(:)=0.
      testi=0
      
!  maximum lateral inflow into this SVC
      DO h=1,size(remainlat)
        remainlat(h)=(latred(tcid_instance2,h)*frac_svc(i,tcid_instance2))/  &
            (tcarea2*1.e3*frac_svc(i,tcid_instance2))
      END DO
      
      
!  check each horizon of SVC if there is lateral inflow (from soil depth
!  above this horizon)
      DO h=1,nbrhori(soilid)
        lath=INT(sum(horiz_thickness(tcid_instance2,i,1:h))/500.)
        IF (lath > 0) THEN
          temp2=sum(remainlat(1:lath))
          
!  update soil moisture of this horizon
!  maximum inflow may be limited by hydraulic conductivity
          IF (temp2 > 0.) THEN
		!Till: compute maximum inflow according to "exchange surface"
		!Andreas: has to be in unit mm, correct calculation similar to lateral outflow calculation
                temp3=k_sat(soilid,h)/dt_per_day*(1.-coarse(soilid,h))* &           ! Q_li 
                  horiz_thickness(tcid_instance2,i,h)*slope(id_tc_type2)/100.  &
                  /  slength(i_lu) / fracterrain(id_tc_type2)/1000.  
            temp3=MIN(temp3,temp2)
            horithact(tcid_instance2,i,h)=horithact(tcid_instance2,i,h)+temp3

            remainlat(1:lath)=0.
            IF (temp3 < temp2) THEN
              remainlat(lath)=temp2-temp3
            END IF
            
!  if horizon is saturated, remaining lateral inflow may be added to
!  lower horizon
            IF (horithact(tcid_instance2,i,h) > thetas(soilid,h)*  &
                  horiz_thickness(tcid_instance2,i,h)) THEN
              remainlat(lath)=remainlat(lath)+ (horithact(tcid_instance2,i,h)-  &
                  thetas(soilid,h)*horiz_thickness(tcid_instance2,i,h))
              horithact(tcid_instance2,i,h)=thetas(soilid,h)* horiz_thickness(tcid_instance2,i,h)


            END IF
          END IF
        END IF
!  enddo horizons
      END DO
      
!  if not all lateral inflow to this SVC can be distributed among the horizons,
!  the remaining inflow is assumed to become subsurface runoff from this
!  terrain component
!  (this is e.g. also the case if the current soil profile is very shallow)
      temp2=sum(remainlat(:))
      IF (temp2 > 0.) THEN
        q_sub_out=q_sub_out+temp2*tcarea2*frac_svc(i,tcid_instance2)*1.e3
        watbal=watbal-temp2*frac_svc(i,tcid_instance2)
      END IF
      
      
!  Calculate new fraction of saturation of current SVC
!  frac_sat value is relative to TC, not to SVC !!
      
      tempth=sum(horithact(tcid_instance2,i,:))
      
! no part of SVC is saturated
      
      IF (tempth <= tctheta_s(1,1,tcid_instance2,i)) THEN
        frac_sat(tcid_instance2,i)=0.
        
! soil component is partly or completely saturated
      ELSE
        
        tempalt=0.
        testi=0
        
        DO j=1,4
          IF (testi == 0) THEN
            
            tempx=tempalt+(tctheta_s(j+1,1,tcid_instance2,i)-  &
                tctheta_s(j,1,tcid_instance2,i))* (tctheta_s(j+1,2,tcid_instance2,i)-  &
                tctheta_s(j,2,tcid_instance2,i))/2.+ (tctheta_s(j+1,1,tcid_instance2,i)-  &
                tctheta_s(j,1,tcid_instance2,i))* (tctheta_s(5,2,tcid_instance2,i)-  &
                (tctheta_s(j+1,2,tcid_instance2,i)- tctheta_s(1,2,tcid_instance2,i)))
            
            IF (tempth > tempalt .AND. tempth < tempx) THEN
              
              frac_sat(tcid_instance2,i)=((tctheta_s(j,2,tcid_instance2,i)-  &
                  tctheta_s(1,2,tcid_instance2,i))+ (tempth-tempalt)/(tempx-tempalt)*  &
                  (tctheta_s(j+1,2,tcid_instance2,i)- tctheta_s(j,2,tcid_instance2,i)))*  &
                  frac_svc(i,tcid_instance2)
              testi=1
            END IF
            tempalt=tempx
          END IF
        END DO
      END IF
! end of update saturated fraction of SVC
      
! end of loop for all SVCs for this uplsope TC
    END DO
    
! end if lateral inflow > 0
  END IF
  latred(tcid_instance2,:)=0.	!Till: set lateral inflow for next timestep to 0
  
! endif choice between lowest and upslope TCs
END IF
